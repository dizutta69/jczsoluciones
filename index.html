<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Financiaci√≥n Solar ‚Äì Colombia (Google Maps)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* Estilos base (se mantienen igual) */
    body{font-family:system-ui;margin:0;padding:1rem;background:#f7f7f7}
    #map, #confirmMap{height:55vh;border-radius:8px;margin:.5rem 0}
    label,input,button{font-size:1rem;padding:.4rem .6rem;margin:.2rem 0}
    #searchBox, #searchBoxSplash, #confirmAddress{width:60%}
    button{cursor:pointer;background:#00704a;color:#fff;border:none;border-radius:4px}
    .splash-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .splash-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    .splash-title {
      color: #00704a;
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 1.8rem;
    }
    .splash-instructions {
      margin-bottom: 2rem;
    }
    .splash-step {
      display: flex;
      margin-bottom: 1rem;
      align-items: flex-start;
    }
    .step-number {
      background: #00704a;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-right: 1rem;
      flex-shrink: 0;
    }
    .step-text {
      flex: 1;
    }
    .splash-button {
      display: block;
      width: 100%;
      padding: 12px;
      background: #00704a;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    .splash-button:hover {
      background: #005a3c;
    }
    
    /* Nuevos estilos para financiaci√≥n */
    .slider-container {
      margin: 2rem 0;
    }
    .slider-value {
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      color: #00704a;
      margin-bottom: 1rem;
    }
    input[type="range"] {
      width: 100%;
      height: 15px;
      -webkit-appearance: none;
      background: #ddd;
      border-radius: 10px;
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #00704a;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .slider-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 0.9rem;
      color: #666;
    }
    
    .finance-results {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 2rem 0;
      text-align: center;
    }
    .finance-item {
      margin: 1rem 0;
      font-size: 1.1rem;
    }
    .finance-label {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }
    .finance-value {
      font-weight: bold;
      color: #00704a;
      font-size: 1.3rem;
    }
    
    .timeline-chart {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1.5rem;
      margin: 2rem 0;
    }
    .timeline-bar {
      height: 30px;
      background: #00704a;
      border-radius: 15px;
      margin: 1rem 0;
      position: relative;
      overflow: hidden;
    }
    .timeline-markers {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 0.8rem;
      color: #666;
    }
    
    /* Estilos para resultados */
    .investment-details {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      text-align: center;
    }
    
    .retorno-destacado {
      background: #e8f5e8;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      border-left: 4px solid #28a745;
      text-align: center;
    }
    
    .retorno-titulo {
      font-size: 1.5rem;
      font-weight: bold;
      color: #28a745;
      margin-bottom: 0.5rem;
    }
    
    .retorno-valor {
      font-size: 2rem;
      font-weight: bold;
      color: #00704a;
    }
    
    .back-button {
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 15px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 1rem;
      transition: background 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .back-button:hover {
      background: #5a6268;
    }
    
    .back-button-container {
      text-align: center;
      margin-top: 1rem;
    }
  </style>
</head>

<body>
  <!-- PANTALLA SPLASH INICIAL -->
  <div id="splashScreen" class="splash-overlay">
    <div class="splash-content">
      <div class="logo-header">
        <img src="logo.png" alt="Energialt SAS" class="logo-img" onerror="this.style.display='none'">
        <h2 class="splash-title">Financiaci√≥n Solar Flexible</h2>
      </div>
      
      <div class="splash-instructions">
        <p style="text-align: center; margin-bottom: 1.5rem;">Dise√±a tu financiamiento ideal para energ√≠a solar:</p>
        
        <!-- PASO 1: Direcci√≥n o Coordenadas -->
        <div class="splash-step">
          <div class="step-number">1</div>
          <div class="step-text">
            <strong>Ingresa tu direcci√≥n O coordenadas</strong>
            <input id="searchBoxSplash" type="text" placeholder="Cra 15 # 120-30, Bogot√°"/>
            <div class="splash-coords">
              <label>Lat: <input id="latTxtSplash" type="text" placeholder="4.711"/></label>
              <label>Lon: <input id="lonTxtSplash" type="text" placeholder="-74.072"/></label>
            </div>
          </div>
        </div>
        
        <!-- PASO 2: Factura mensual -->
        <div class="splash-step">
          <div class="step-number">2</div>
          <div class="step-text">
            <strong>Ingresa el valor de tu factura mensual</strong>
            <input id="billSplash" type="number" placeholder="200000"/>
          </div>
        </div>
      </div>
      
      <button id="cotizarSplash" class="splash-button">Calcular Financiaci√≥n</button>
    </div>
  </div>

  <!-- PANTALLA DE CONFIRMACI√ìN DE UBICACI√ìN -->
  <div id="confirmLocationScreen" class="splash-overlay" style="display: none;">
    <div class="splash-content">
      <div class="logo-header">
        <img src="logo.png" alt="Energialt SAS" class="logo-img" onerror="this.style.display='none'">
        <h2 class="splash-title">Confirma tu ubicaci√≥n</h2>
      </div>
      
      <div class="location-controls">
        <div class="location-field">
          <label for="confirmAddress">Direcci√≥n:</label>
          <input id="confirmAddress" type="text" placeholder="Ingresa o ajusta la direcci√≥n"/>
        </div>
        
        <div class="location-field">
          <label>Coordenadas:</label>
          <div class="coord-inputs">
            <input id="confirmLat" type="text" placeholder="Latitud"/>
            <input id="confirmLon" type="text" placeholder="Longitud"/>
          </div>
        </div>
      </div>
      
      <div id="confirmMap" style="height: 300px; border-radius: 8px; margin-bottom: 1rem;"></div>
      
      <button id="confirmLocationBtn" class="splash-button">Confirmar Ubicaci√≥n</button>
      
      <div class="back-button-container">
        <button id="backToSplashFromConfirm" class="back-button">
          ‚Üê Volver a editar datos
        </button>
      </div>
    </div>
  </div>

  <!-- PANTALLA DE FINANCIACI√ìN -->
  <div id="financeScreen" class="splash-overlay" style="display: none;">
    <div class="splash-content">
      <div class="logo-header">
        <img src="logo.png" alt="Energialt SAS" class="logo-img" onerror="this.style.display='none'">
        <h2 class="splash-title">Dise√±a tu Financiaci√≥n</h2>
        <p style="text-align: center; color: #666;">Tu cuota mensual ser√° el 70% de tu factura actual</p>
      </div>
      
      <div class="investment-details">
        <div class="finance-item">
          <div class="finance-label">Valor total del sistema</div>
          <div class="finance-value" id="totalSystemValue">$0 COP</div>
        </div>
      </div>
      
      <div class="slider-container">
        <div class="slider-value" id="downPaymentValue">$0 COP</div>
        <input type="range" id="downPaymentSlider" min="0" max="100" value="20" step="5">
        <div class="slider-labels">
          <span>$0 COP</span>
          <span>Pago inicial</span>
          <span id="maxDownPayment">$0 COP</span>
        </div>
        <p style="text-align: center; font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
          Desliza para ajustar tu pago inicial
        </p>
      </div>
      
      <div class="finance-results">
        <div class="finance-item">
          <div class="finance-label">Pago inicial seleccionado</div>
          <div class="finance-value" id="selectedDownPayment">$0 COP</div>
        </div>
        
        <div class="finance-item">
          <div class="finance-label">Cuota mensual fija</div>
          <div class="finance-value" id="monthlyPayment">$0 COP</div>
          <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
            (70% de tu factura actual)
          </div>
        </div>
        
        <div class="finance-item">
          <div class="finance-label">Tiempo total de financiaci√≥n</div>
          <div class="finance-value" id="financeTerm">0 a√±os 0 meses</div>
        </div>
        
        <div class="finance-item">
          <div class="finance-label">Tasa de inter√©s anual</div>
          <div class="finance-value">24%</div>
        </div>
      </div>
      
      <!-- Gr√°fica de timeline -->
      <div class="timeline-chart">
        <h3 style="text-align: center; margin-bottom: 1rem;">L√≠nea de tiempo de pagos</h3>
        <div class="timeline-bar" id="timelineBar">
          <div id="timelineProgress" style="position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: #28a745; border-radius: 15px;"></div>
        </div>
        <div class="timeline-markers">
          <span id="timelineStart">Hoy</span>
          <span id="timelineMiddle">50%</span>
          <span id="timelineEnd">Fin</span>
        </div>
      </div>
      
      <div class="retorno-destacado">
        <div class="retorno-titulo">¬°Desde el primer d√≠a ahorras!</div>
        <div class="retorno-valor" id="immediateSavings">$0 COP/mes</div>
        <p style="margin-top: 0.5rem; color: #666;">
          Tu factura baja inmediatamente, mientras pagas el sistema
        </p>
      </div>
      
      <button id="nextToFormBtn" class="splash-button">Continuar con mis datos</button>
      
      <div class="back-button-container">
        <button id="backToConfirmFromFinance" class="back-button">
          ‚Üê Volver a ajustar ubicaci√≥n
        </button>
      </div>
    </div>
  </div>

  <!-- PANTALLA DE FORMULARIO (igual que antes) -->
  <div id="formScreen" class="splash-overlay" style="display: none;">
    <div class="splash-content">
      <div class="logo-header">
        <img src="logo.png" alt="Energialt SAS" class="logo-img" onerror="this.style.display='none'">
        <h2 class="splash-title">Completa tus datos</h2>
      </div>
      
      <div class="email-form">
        <div class="form-group">
          <label for="userName">Nombre completo</label>
          <input type="text" id="userName" placeholder="Ingresa tu nombre">
        </div>
        
        <div class="form-group">
          <label for="userEmail">Correo electr√≥nico</label>
          <input type="email" id="userEmail" placeholder="Ingresa tu email">
        </div>
        
        <div class="form-group">
          <label for="userPhone">Tel√©fono</label>
          <input type="tel" id="userPhone" placeholder="Ingresa tu tel√©fono">
        </div>
        
        <button id="sendFinanceBtn" class="splash-button">Solicitar financiaci√≥n</button>
      </div>

      <div class="back-button-container">
        <button id="backToFinanceFromForm" class="back-button">
          ‚Üê Volver a ajustar financiaci√≥n
        </button>
      </div>
    </div>
  </div>

  <!-- PANTALLA FINAL -->
  <div id="finalScreen" class="splash-overlay" style="display: none;">
    <div class="splash-content">
      <div class="logo-header" style="text-align: center; margin-bottom: 2rem;">
        <img src="logo.png" alt="Energialt SAS" class="logo-img" onerror="this.style.display='none'">
      </div>
      
      <div style="text-align: center; margin-bottom: 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
        <h2 class="splash-title">¬°Solicitud Enviada!</h2>
      </div>
      
      <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
        <h3 style="color: #00704a; margin-bottom: 1rem;">Resumen de tu solicitud</h3>
        <div id="finalSummary"></div>
      </div>
      
      <button id="newRequestBtn" class="splash-button" style="background: #28a745;">
        üîÑ Nueva Solicitud
      </button>
    </div>
  </div>

  <script>
    // Variables globales
    let currentSystemValue = 0;
    let currentMonthlyBill = 0;
    let currentMonthlyPayment = 0;
    let currentDownPayment = 0;
    let financeTermMonths = 0;
    const INTEREST_RATE = 0.24; // 24% anual
    const TARGET_PERCENTAGE = 0.7; // 70% de la factura

    // Funciones de formato
    function formatoDineroCOP(valor) {
      const numeroFormateado = valor.toLocaleString('es-CO', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      });
      return '$' + numeroFormateado;
    }

    // Funci√≥n para calcular la cotizaci√≥n del sistema
    async function calcularCotizacion(lat, lon, bill) {
      const PRICE_KWH = 890;
      const USD_COP = 4000;
      const USD_W_INSTALLED = 0.9;
      const PANEL_W = 450;
      const AREA_POR_PANEL = 2.2;
      const COSTO_FIJO_COP = 3000000;

      try {
        const kwhMonth = bill / PRICE_KWH;
        const kwh70 = kwhMonth * TARGET_PERCENTAGE;

        let specific = 1350; // Valor por defecto

        try {
          const response = await fetch(
            `https://developer.nrel.gov/api/pvwatts/v8.json?api_key=ECmQDDWbYsWgQ4pFg2zFUZdlbTirJhA1pnfQRRC4&lat=${lat}&lon=${lon}&system_capacity=1&azimuth=180&tilt=${Math.abs(lat)}&array_type=1&module_type=0&losses=14&timeframe=monthly`
          );
          
          if (response.ok) {
            const pvw = await response.json();
            if(pvw && pvw.outputs && pvw.outputs.ac_annual) {
              specific = pvw.outputs.ac_annual;
            }
          }
        } catch(error) {
          console.warn('Error PVWatts, usando valor por defecto:', error);
        }

        const kwp = (kwh70 * 12) / specific;
        const currentPanels = Math.ceil(kwp / (PANEL_W/1000));
        const kwpReal = currentPanels * (PANEL_W/1000);

        const priceUsd = kwpReal * 1000 * USD_W_INSTALLED;
        currentSystemValue = priceUsd * USD_COP + COSTO_FIJO_COP;
        
        // Calcular pago mensual (70% de la factura)
        currentMonthlyPayment = bill * TARGET_PERCENTAGE;
        currentMonthlyBill = bill;

        return {
          systemValue: currentSystemValue,
          monthlyPayment: currentMonthlyPayment,
          panels: currentPanels
        };
        
      } catch (error) {
        console.error('Error en c√°lculo:', error);
        throw error;
      }
    }

    // Funci√≥n para calcular financiaci√≥n con inter√©s compuesto
    function calcularFinanciacion(valorTotal, pagoInicial, cuotaMensual, tasaAnual) {
      const valorFinanciado = valorTotal - pagoInicial;
      const tasaMensual = tasaAnual / 12;
      
      if (cuotaMensual <= 0) return { meses: 0, totalIntereses: 0 };
      
      // F√≥rmula para calcular el n√∫mero de meses con inter√©s compuesto
      // n = log(1 - (P * r) / A) / log(1 + r)
      // Donde:
      // n = n√∫mero de meses
      // P = cuota mensual
      // r = tasa de inter√©s mensual
      // A = valor financiado
      
      const r = tasaMensual;
      const P = cuotaMensual;
      const A = valorFinanciado;
      
      if (P <= A * r) {
        // La cuota es menor o igual al inter√©s, nunca terminar√° de pagar
        return { meses: Infinity, totalIntereses: Infinity };
      }
      
      const n = -Math.log(1 - (A * r) / P) / Math.log(1 + r);
      const meses = Math.ceil(n);
      const totalPagado = P * meses;
      const totalIntereses = totalPagado - valorFinanciado;
      
      return {
        meses: meses,
        a√±os: Math.floor(meses / 12),
        mesesRestantes: meses % 12,
        totalIntereses: totalIntereses,
        totalPagado: totalPagado
      };
    }

    // Funci√≥n para actualizar la interfaz de financiaci√≥n
    function actualizarFinanciacion() {
      const slider = document.getElementById('downPaymentSlider');
      const percentage = parseInt(slider.value);
      
      // Calcular pago inicial en pesos
      currentDownPayment = (currentSystemValue * percentage) / 100;
      
      // Actualizar valores en pantalla
      document.getElementById('downPaymentValue').textContent = formatoDineroCOP(currentDownPayment);
      document.getElementById('selectedDownPayment').textContent = formatoDineroCOP(currentDownPayment);
      document.getElementById('monthlyPayment').textContent = formatoDineroCOP(currentMonthlyPayment);
      
      // Calcular financiaci√≥n
      const resultado = calcularFinanciacion(
        currentSystemValue,
        currentDownPayment,
        currentMonthlyPayment,
        INTEREST_RATE
      );
      
      financeTermMonths = resultado.meses;
      
      // Formatear tiempo
      let tiempoTexto = '';
      if (resultado.a√±os > 0) {
        tiempoTexto += resultado.a√±os + ' a√±o' + (resultado.a√±os !== 1 ? 's' : '');
      }
      if (resultado.mesesRestantes > 0) {
        if (resultado.a√±os > 0) tiempoTexto += ' ';
        tiempoTexto += resultado.mesesRestantes + ' mes' + (resultado.mesesRestantes !== 1 ? 'es' : '');
      }
      if (resultado.a√±os === 0 && resultado.mesesRestantes === 0) {
        tiempoTexto = 'Menos de 1 mes';
      }
      
      document.getElementById('financeTerm').textContent = tiempoTexto;
      
      // Actualizar gr√°fica de timeline
      const maxMeses = 25 * 12; // 25 a√±os m√°ximo
      const progressPercentage = Math.min((financeTermMonths / maxMeses) * 100, 100);
      document.getElementById('timelineProgress').style.width = progressPercentage + '%';
      
      // Actualizar ahorro inmediato
      const ahorroInmediato = currentMonthlyBill - currentMonthlyPayment;
      document.getElementById('immediateSavings').textContent = formatoDineroCOP(ahorroInmediato) + '/mes';
      
      // Actualizar marcadores de timeline
      if (resultado.a√±os > 0) {
        const mitadA√±os = Math.floor(resultado.a√±os / 2);
        document.getElementById('timelineMiddle').textContent = mitadA√±os + ' a√±os';
        document.getElementById('timelineEnd').textContent = resultado.a√±os + ' a√±os';
      }
    }

    // Funci√≥n para inicializar la pantalla de financiaci√≥n
    function inicializarPantallaFinanciacion() {
      // Establecer valores m√°ximos
      document.getElementById('totalSystemValue').textContent = formatoDineroCOP(currentSystemValue);
      document.getElementById('maxDownPayment').textContent = formatoDineroCOP(currentSystemValue);
      
      // Configurar slider
      const slider = document.getElementById('downPaymentSlider');
      slider.max = 100;
      slider.value = 20; // 20% por defecto
      
      // Event listener para slider
      slider.addEventListener('input', actualizarFinanciacion);
      
      // Calcular primera vez
      actualizarFinanciacion();
    }

    // Funci√≥n para mostrar resumen final
    function mostrarResumenFinal() {
      const resumenHTML = `
        <div style="text-align: left;">
          <p><strong>Pago inicial seleccionado:</strong> ${formatoDineroCOP(currentDownPayment)}</p>
          <p><strong>Cuota mensual:</strong> ${formatoDineroCOP(currentMonthlyPayment)}</p>
          <p><strong>Tiempo de financiaci√≥n:</strong> ${document.getElementById('financeTerm').textContent}</p>
          <p><strong>Valor total del sistema:</strong> ${formatoDineroCOP(currentSystemValue)}</p>
          <p><strong>Ahorro mensual inmediato:</strong> ${document.getElementById('immediateSavings').textContent}</p>
        </div>
      `;
      
      document.getElementById('finalSummary').innerHTML = resumenHTML;
    }

    // FLUJO PRINCIPAL
    async function iniciarCalculoFinanciacion() {
      // Obtener coordenadas
      const lat = parseFloat(document.getElementById('latTxtSplash').value);
      const lon = parseFloat(document.getElementById('lonTxtSplash').value);
      const bill = parseFloat(document.getElementById('billSplash').value);
      
      if(isNaN(bill) || bill <= 0){ 
        alert('Define una factura mayor a 0'); 
        return; 
      }
      
      // Calcular sistema
      try {
        await calcularCotizacion(lat, lon, bill);
        
        // Ocultar splash, mostrar financiaci√≥n
        document.getElementById('splashScreen').style.display = 'none';
        document.getElementById('financeScreen').style.display = 'flex';
        
        // Inicializar pantalla de financiaci√≥n
        inicializarPantallaFinanciacion();
        
      } catch (error) {
        alert('Error en el c√°lculo. Verifica los datos.');
        console.error(error);
      }
    }

    // EVENT LISTENERS
    document.addEventListener('DOMContentLoaded', function() {
      // Bot√≥n para calcular
      document.getElementById('cotizarSplash').addEventListener('click', iniciarCalculoFinanciacion);
      
      // Bot√≥n para continuar al formulario
      document.getElementById('nextToFormBtn').addEventListener('click', function() {
        document.getElementById('financeScreen').style.display = 'none';
        document.getElementById('formScreen').style.display = 'flex';
      });
      
      // Bot√≥n para enviar solicitud
      document.getElementById('sendFinanceBtn').addEventListener('click', function() {
        const userName = document.getElementById('userName').value;
        const userEmail = document.getElementById('userEmail').value;
        const userPhone = document.getElementById('userPhone').value;
        
        if (!userName || !userEmail || !userPhone) {
          alert('Por favor completa todos los campos');
          return;
        }
        
        // Aqu√≠ ir√≠a la funci√≥n para guardar en Google Sheets
        // guardarSolicitudFinanciacion(userName, userEmail, userPhone);
        
        // Mostrar resumen y pantalla final
        mostrarResumenFinal();
        document.getElementById('formScreen').style.display = 'none';
        document.getElementById('finalScreen').style.display = 'flex';
      });
      
      // Bot√≥n para nueva solicitud
      document.getElementById('newRequestBtn').addEventListener('click', function() {
        window.location.reload();
      });
      
      // Botones volver
      document.getElementById('backToFinanceFromForm').addEventListener('click', function() {
        document.getElementById('formScreen').style.display = 'none';
        document.getElementById('financeScreen').style.display = 'flex';
      });
    });

    // Funci√≥n para guardar en Google Sheets (modificar seg√∫n tu script)
    async function guardarSolicitudFinanciacion(nombre, email, telefono) {
      const datos = {
        nombre: nombre,
        email: email,
        telefono: telefono,
        sistema_valor: currentSystemValue,
        pago_inicial: currentDownPayment,
        cuota_mensual: currentMonthlyPayment,
        plazo_meses: financeTermMonths,
        factura_actual: currentMonthlyBill,
        lat: document.getElementById('latTxtSplash').value,
        lon: document.getElementById('lonTxtSplash').value,
        direccion: document.getElementById('searchBoxSplash').value,
        tipo: 'financiacion'
      };
      
      // Tu c√≥digo para enviar a Google Sheets aqu√≠
      console.log('Datos a guardar:', datos);
      return true;
    }
  </script>
</body>
</html>
