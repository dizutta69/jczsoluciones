<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Financiaci√≥n Solar Inteligente ‚Äì Colombia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* ESTILOS BASE OPTIMIZADOS */
    body{font-family:system-ui;margin:0;padding:0;background:#f7f7f7}
    .splash-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(0,112,74,0.9) 0%, rgba(0,80,53,0.9) 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .splash-content {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      border: 1px solid rgba(0,112,74,0.1);
    }
    .splash-title {
      color: #00704a;
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 1.8rem;
      font-weight: 700;
    }
    .splash-instructions {
      margin-bottom: 2rem;
    }
    .splash-step {
      display: flex;
      margin-bottom: 1.5rem;
      align-items: flex-start;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #00704a;
    }
    .step-number {
      background: #00704a;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-right: 1rem;
      flex-shrink: 0;
      font-weight: bold;
      font-size: 1.1rem;
    }
    .step-text {
      flex: 1;
    }
    .splash-button {
      display: block;
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #00704a, #005a3c);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      margin-top: 1rem;
    }
    .splash-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,112,74,0.3);
    }

    /* INPUTS MEJORADOS */
    .splash-step input {
      width: 100%;
      margin-top: 0.5rem;
      padding: 0.75rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
      transition: all 0.3s;
    }
    .splash-step input:focus {
      border-color: #00704a;
      box-shadow: 0 0 0 3px rgba(0,112,74,0.1);
      outline: none;
    }
    
    .pac-container {
      border-radius: 8px;
      border: 2px solid #00704a;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      z-index: 10000 !important;
    }
    
    .splash-coords {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      color: #666;
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .splash-coords label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: white;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }
    
    .splash-coords input {
      width: 100px;
      padding: 0.5rem;
      border: 1px solid #e0e0e0;
      background: #f9f9f9;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    /* ESTILOS PARA FINANCIACI√ìN */
    .slider-container {
      margin: 2rem 0;
      padding: 1.5rem;
      background: linear-gradient(135deg, #f8f9fa, #ffffff);
      border-radius: 12px;
      border: 2px solid #e8f5e8;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .slider-value {
      text-align: center;
      font-size: 2.2rem;
      font-weight: bold;
      color: #00704a;
      margin-bottom: 1rem;
      padding: 1rem;
      background: white;
      border-radius: 10px;
      border: 3px solid #00704a;
      box-shadow: 0 4px 6px rgba(0,112,74,0.1);
    }
    
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 12px;
      border-radius: 6px;
      background: linear-gradient(to right, #2ecc71, #f39c12, #e74c3c);
      outline: none;
      margin: 20px 0;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #00704a;
      cursor: pointer;
      border: 4px solid white;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      transition: all 0.2s;
    }
    
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(0,112,74,0.4);
    }
    
    .slider-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 0.9rem;
      color: #666;
      font-weight: 600;
    }
    
    .finance-results {
      background: linear-gradient(135deg, #ffffff, #f8f9fa);
      padding: 1.5rem;
      border-radius: 12px;
      margin: 2rem 0;
      border: 2px solid #00704a;
      box-shadow: 0 8px 25px rgba(0,112,74,0.1);
    }
    
    .finance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }
    
    .finance-card {
      background: white;
      padding: 1.2rem;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      border-top: 5px solid #00704a;
      transition: transform 0.3s;
    }
    
    .finance-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,112,74,0.15);
    }
    
    .finance-label {
      font-size: 0.95rem;
      color: #666;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    
    .finance-value {
      font-size: 1.6rem;
      font-weight: bold;
      color: #00704a;
      margin: 0.5rem 0;
    }
    
    /* NUEVAS M√âTRICAS DE ROI */
    .roi-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin: 2rem 0;
    }
    
    .roi-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border-top: 6px solid;
      transition: all 0.3s;
    }
    
    .roi-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .roi-card.positive {
      border-top-color: #28a745;
      background: linear-gradient(135deg, #f8fff9, #ffffff);
    }
    
    .roi-card.neutral {
      border-top-color: #ffc107;
      background: linear-gradient(135deg, #fff9e6, #ffffff);
    }
    
    .roi-card.info {
      border-top-color: #17a2b8;
      background: linear-gradient(135deg, #e6f7ff, #ffffff);
    }
    
    .roi-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    
    .roi-title {
      font-size: 1.1rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 0.5rem;
    }
    
    .roi-value {
      font-size: 1.8rem;
      font-weight: bold;
      margin: 1rem 0;
    }
    
    .roi-detail {
      font-size: 0.9rem;
      color: #666;
      margin-top: 0.5rem;
    }
    
    .scale-discount-badge {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
      display: inline-block;
      margin-top: 1rem;
      box-shadow: 0 3px 10px rgba(40,167,69,0.3);
    }
    
    /* TIMELINE */
    .timeline-container {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin: 2rem 0;
      border: 1px solid #e0e0e0;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .investment-message {
      background: linear-gradient(135deg, #e8f5e8, #d4edda);
      padding: 2rem;
      border-radius: 12px;
      margin: 2rem 0;
      text-align: center;
      border-left: 5px solid #28a745;
      box-shadow: 0 5px 15px rgba(40,167,69,0.1);
    }
    
    .investment-title {
      font-size: 1.6rem;
      font-weight: bold;
      color: #28a745;
      margin-bottom: 1rem;
    }
    
    /* LOGO Y HEADER */
    .logo-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 3px solid #00704a;
      background: linear-gradient(135deg, #f8fff9, #ffffff);
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,112,74,0.1);
    }
    
    .logo-img {
      max-height: 70px;
      width: auto;
      margin-bottom: 1rem;
    }
    
    /* BOTONES VOLVER */
    .back-button {
      background: linear-gradient(135deg, #6c757d, #5a6268);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 0.95rem;
      cursor: pointer;
      margin-top: 1rem;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    
    .back-button:hover {
      transform: translateX(-5px);
      box-shadow: 0 5px 15px rgba(108,117,125,0.3);
    }
    
    /* ANIMACIONES */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .splash-content {
      animation: fadeIn 0.5s ease-out;
    }
    
    /* RESPONSIVE */
    @media (max-width: 768px) {
      .splash-content {
        padding: 1.5rem;
        width: 95%;
      }
      
      .finance-grid, .roi-metrics {
        grid-template-columns: 1fr;
      }
      
      .splash-coords {
        flex-direction: column;
        align-items: stretch;
      }
      
      .splash-coords label {
        justify-content: space-between;
      }
      
      .splash-coords input {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <!-- PANTALLA SPLASH INICIAL CON AUTOCOMPLETE MEJORADO -->
  <div id="splashScreen" class="splash-overlay">
    <div class="splash-content">
      <div class="logo-header">
        <img src="logo.png" alt="JZL Soluciones" class="logo-img" onerror="this.style.display='none'">
        <h2 class="splash-title">Financiaci√≥n Solar Inteligente</h2>
        <p style="color: #666; margin-top: 0.5rem;">Convierte tu factura de luz en una inversi√≥n</p>
      </div>
      
      <div class="splash-instructions">
        <div class="splash-step">
          <div class="step-number">1</div>
          <div class="step-text">
            <strong>üìç Ingresa tu direcci√≥n</strong>
            <input id="searchBoxSplash" type="text" placeholder="Ej: Cra 15 # 120-30, Bogot√°" autocomplete="off"/>
            <div class="splash-coords">
              <label>üìê Lat: <input id="latTxtSplash" type="text" placeholder="4.711"/></label>
              <label>üìê Lon: <input id="lonTxtSplash" type="text" placeholder="-74.072"/></label>
            </div>
            <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem; background: #e8f5e8; padding: 0.5rem; border-radius: 6px;">
              üí° <strong>Escribe tu direcci√≥n y selecciona una sugerencia</strong> o ingresa coordenadas manualmente
            </p>
          </div>
        </div>
        
        <div class="splash-step">
          <div class="step-number">2</div>
          <div class="step-text">
            <strong>üí° Ingresa tu factura mensual actual</strong>
            <input id="billSplash" type="number" placeholder="Ej: 200000 (COP)"/>
            <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem; background: #e3f2fd; padding: 0.5rem; border-radius: 6px;">
              üìä Tu cuota de financiaci√≥n ser√° el <strong>70%</strong> de este valor
            </p>
          </div>
        </div>
      </div>
      
      <button id="cotizarSplash" class="splash-button">‚ú® Calcular Mi Financiaci√≥n</button>
    </div>
  </div>

  <!-- PANTALLA DE CONFIRMACI√ìN -->
  <div id="confirmLocationScreen" class="splash-overlay" style="display: none;">
    <div class="splash-content">
      <div class="logo-header">
        <img src="logo.png" alt="JZL Soluciones" class="logo-img" onerror="this.style.display='none'">
        <h2 class="splash-title">Confirma tu ubicaci√≥n</h2>
        <p style="color: #666; margin-top: 0.5rem;">Ajusta el marcador si es necesario</p>
      </div>
      
      <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #e0e0e0;">
        <div style="margin-bottom: 1rem;">
          <label for="confirmAddress" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #00704a;">üìç Direcci√≥n:</label>
          <input id="confirmAddress" type="text" placeholder="Ingresa o ajusta la direcci√≥n" style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"/>
        </div>
        
        <div>
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #00704a;">üåê Coordenadas:</label>
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <input id="confirmLat" type="text" placeholder="Latitud" style="flex: 1; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"/>
            <input id="confirmLon" type="text" placeholder="Longitud" style="flex: 1; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"/>
          </div>
        </div>
      </div>
      
      <div id="confirmMap" style="height: 300px; border-radius: 10px; margin-bottom: 1.5rem; border: 2px solid #ddd;"></div>
      
      <button id="confirmLocationBtn" class="splash-button">‚úÖ Confirmar Ubicaci√≥n</button>
      
      <div style="text-align: center; margin-top: 1.5rem;">
        <button id="backToSplashFromConfirm" class="back-button">
          ‚Üê Volver a editar datos
        </button>
      </div>
    </div>
  </div>

  <!-- PANTALLA DE FINANCIACI√ìN CON M√âTRICAS ROI -->
  <div id="financeScreen" class="splash-overlay" style="display: none;">
    <div class="splash-content">
      <div class="logo-header">
        <img src="logo.png" alt="JZL Soluciones" class="logo-img" onerror="this.style.display='none'">
        <h2 class="splash-title">Dise√±a tu Financiaci√≥n</h2>
        <p style="color: #666; margin-top: 0.5rem;">
          Tu cuota mensual ser√° el <strong style="color: #00704a;">70% de tu factura actual</strong>
        </p>
      </div>
      
      <!-- Sistema Calculado -->
      <div style="background: linear-gradient(135deg, #f8f9fa, #ffffff); padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0; border: 2px solid #e0e0e0;">
        <div style="text-align: center; margin-bottom: 1rem;">
          <div style="font-size: 1.1rem; color: #666; margin-bottom: 0.5rem;">Sistema solar estimado para tu consumo</div>
          <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
            <div style="text-align: center;">
              <div style="font-size: 0.9rem; color: #888;">Paneles</div>
              <div style="font-size: 2rem; font-weight: bold; color: #00704a;" id="totalPanels">0</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 0.9rem; color: #888;">Potencia</div>
              <div style="font-size: 2rem; font-weight: bold; color: #00704a;" id="totalKWp">0 kWp</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 0.9rem; color: #888;">Valor base</div>
              <div style="font-size: 1.8rem; font-weight: bold; color: #00704a;" id="totalSystemValue">$0 COP</div>
            </div>
          </div>
        </div>
        
        <!-- Descuento por Escala -->
        <div id="scaleDiscountDisplay" style="text-align: center; margin-top: 1rem; display: none;">
          <div class="scale-discount-badge">
            üéØ Descuento por escala: <span id="discountPercentage">0%</span>
          </div>
          <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
            Sistemas m√°s grandes obtienen mejor relaci√≥n costo/beneficio
          </p>
        </div>
      </div>
      
      <!-- Control deslizante -->
      <div class="slider-container">
        <h3 style="text-align: center; margin-bottom: 1rem; color: #00704a;">
          üí∞ Ajusta tu pago inicial
        </h3>
        
        <div class="slider-value" id="downPaymentValue">
          $0 COP
        </div>
        
        <div style="position: relative;">
          <input type="range" id="downPaymentSlider" min="0" max="100" value="20" step="1">
        </div>
        
        <div style="text-align: center; margin-top: 0.5rem;">
          <div style="font-size: 1.2rem; font-weight: bold; color: #00704a;" id="downPaymentPercentage">20%</div>
          <div style="font-size: 0.9rem; color: #888;">del valor total</div>
        </div>
        
        <div class="slider-labels">
          <span>$0 COP</span>
          <span style="color: #00704a; font-weight: bold;">Pago inicial</span>
          <span id="maxDownPaymentLabel">$0 COP</span>
        </div>
        
        <p style="text-align: center; font-size: 0.9rem; color: #666; margin-top: 1.5rem; padding: 1rem; background: #e8f5e8; border-radius: 8px;">
          üí° <strong>Desliza para ajustar cu√°nto quieres pagar inicialmente.</strong><br>
          A mayor cuota inicial, reduces tu tiempo de financiaci√≥n m√°s r√°pido.
        </p>
      </div>
      
      <!-- Resultados de financiaci√≥n -->
      <div class="finance-results">
        <h3 style="text-align: center; margin-bottom: 1.5rem; color: #00704a;">
          üìã Resumen de financiaci√≥n
        </h3>
        
        <div class="finance-grid">
          <div class="finance-card">
            <div class="finance-label">Pago inicial</div>
            <div class="finance-value" id="selectedDownPayment">$0 COP</div>
            <div style="font-size: 0.8rem; color: #888;" id="downPaymentPercent">0% del total</div>
          </div>
          
          <div class="finance-card">
            <div class="finance-label">Valor financiado</div>
            <div class="finance-value" id="financedAmount">$0 COP</div>
            <div style="font-size: 0.8rem; color: #888;">Saldo a pagar</div>
          </div>
          
          <div class="finance-card">
            <div class="finance-label">Cuota mensual</div>
            <div class="finance-value" id="monthlyPayment">$0 COP</div>
            <div style="font-size: 0.8rem; color: #888;">70% de tu factura</div>
          </div>
          
          <div class="finance-card">
            <div class="finance-label">Plazo total</div>
            <div class="finance-value" id="financeTerm">0 meses</div>
            <div style="font-size: 0.8rem; color: #888;" id="financeYears">0 a√±os</div>
          </div>
        </div>
        
        <!-- L√≠neas de financiamiento -->
        <div style="margin-top: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: white; border-radius: 8px; margin: 0.5rem 0; border-left: 4px solid #00704a;">
            <span>Sistema solar con servicios (5 a√±os):</span>
            <strong style="font-size: 1.2rem; color: #00704a;" id="systemWithServices">$0 COP</strong>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: white; border-radius: 8px; margin: 0.5rem 0; border-left: 4px solid #28a745;">
            <span>Pago inicial seleccionado:</span>
            <strong style="font-size: 1.2rem; color: #28a745;" id="downPaymentLine">$0 COP</strong>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #e8f5e8; border-radius: 8px; margin: 0.5rem 0; border-left: 4px solid #00704a; font-weight: bold;">
            <span>Saldo a financiar:</span>
            <strong style="font-size: 1.3rem; color: #00704a;" id="balanceToFinance">$0 COP</strong>
          </div>
        </div>
      </div>
      
      <!-- NUEVAS M√âTRICAS DE ROI -->
      <div class="roi-metrics">
        <div class="roi-card positive">
          <div class="roi-icon">üí∞</div>
          <div class="roi-title">Flujo mensual inmediato</div>
          <div class="roi-value" id="roiFlujoMensual">$0 COP/mes</div>
          <div class="roi-detail">Desde el primer mes</div>
        </div>
        
        <div class="roi-card neutral">
          <div class="roi-icon">üéØ</div>
          <div class="roi-title">Recuperaci√≥n pago inicial</div>
          <div class="roi-value" id="roiRecuperacion">0 a√±os</div>
          <div class="roi-detail" id="roiRecuperacionDetail">Tiempo para recuperar tu inversi√≥n</div>
        </div>
        
        <div class="roi-card info">
          <div class="roi-icon">üìà</div>
          <div class="roi-title">Equilibrio del proyecto</div>
          <div class="roi-value" id="roiEquilibrio">0 a√±os</div>
          <div class="roi-detail" id="roiEquilibrioDetail">Cuando el proyecto se paga solo</div>
        </div>
      </div>
      
      <!-- Timeline -->
      <div class="timeline-container">
        <h3 style="text-align: center; margin-bottom: 1rem; color: #00704a;">
          ‚è±Ô∏è Proyecci√≥n de pagos
        </h3>
        
        <div style="height: 30px; background: #e9ecef; border-radius: 15px; margin: 1.5rem 0; position: relative; overflow: hidden;">
          <div id="timelineProgress" style="position: absolute; left: 0; top: 0; height: 100%; background: linear-gradient(90deg, #2ecc71, #f39c12); border-radius: 15px; transition: width 0.5s ease; width: 0%;"></div>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem; color: #666; font-weight: 600;">
          <span>üèÅ Inicio</span>
          <span id="midTerm">Mitad</span>
          <span id="endTerm">Finalizaci√≥n</span>
        </div>
        
        <p style="text-align: center; font-size: 0.9rem; color: #666; margin-top: 1.5rem;">
          Tiempo estimado para completar el pago: <strong id="estimatedTime" style="color: #00704a;">0 meses</strong>
        </p>
      </div>
      
      <!-- Mensaje de inversi√≥n -->
      <div class="investment-message">
        <div class="investment-title">¬°Convierte tu pago de energ√≠a en inversi√≥n desde el primer mes!</div>
        <div style="font-size: 2.2rem; font-weight: bold; color: #00704a; margin: 1rem 0;" id="immediateSavings">$0 COP/mes</div>
        <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
          Mientras pagas el sistema, tu factura baja inmediatamente<br>
          <span style="font-weight: bold; color: #ff6b6b;" id="originalBill">Factura actual: $0 COP</span> ‚Üí 
          <span style="font-weight: bold; color: #2ea642;" id="newBill">Nueva factura: $0 COP</span>
        </p>
        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.8); border-radius: 8px;">
          <div style="font-size: 0.9rem; color: #666;">üéØ <strong>Incluye todo por 5 a√±os:</strong> Mantenimiento + Atenci√≥n prioritaria + Plataforma de monitoreo</div>
        </div>
      </div>
      
      <button id="nextToFormBtn" class="splash-button">üìù Continuar con mis datos</button>
      
      <div style="text-align: center; margin-top: 1.5rem;">
        <button id="backToConfirmFromFinance" class="back-button">
          ‚Üê Volver a ajustar ubicaci√≥n
        </button>
      </div>
    </div>
  </div>

  <!-- PANTALLA DE FORMULARIO -->
  <div id="formScreen" class="splash-overlay" style="display: none;">
    <div class="splash-content">
      <div class="logo-header">
        <img src="logo.png" alt="JZL Soluciones" class="logo-img" onerror="this.style.display='none'">
        <h2 class="splash-title">Completa tus datos</h2>
      </div>
      
      <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-top: 1rem;">
        <div style="background: #e8f5e8; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center;">
          <p style="margin: 0; color: #00704a; font-weight: bold; font-size: 1.1rem;">
            ¬°Est√°s a un paso de convertir tu factura de luz en una inversi√≥n!
          </p>
        </div>

        <div style="margin-bottom: 1.5rem;">
          <label for="userName" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">üë§ Nombre completo</label>
          <input type="text" id="userName" placeholder="Ingresa tu nombre completo" style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"/>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
          <label for="userEmail" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">üìß Correo electr√≥nico</label>
          <input type="email" id="userEmail" placeholder="ejemplo@email.com" style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"/>
        </div>
        
        <div style="margin-bottom: 2rem;">
          <label for="userPhone" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">üì± Tel√©fono</label>
          <input type="tel" id="userPhone" placeholder="Ingresa tu n√∫mero de tel√©fono" style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"/>
        </div>
        
        <button id="sendFinanceBtn" class="splash-button">‚úÖ Solicitar financiaci√≥n</button>
      </div>

      <div style="text-align: center; margin-top: 1.5rem;">
        <button id="backToFinanceFromForm" class="back-button">
          ‚Üê Volver a ajustar financiaci√≥n
        </button>
      </div>
    </div>
  </div>

  <!-- PANTALLA FINAL -->
  <div id="finalScreen" class="splash-overlay" style="display: none;">
    <div class="splash-content">
      <div class="logo-header" style="text-align: center; margin-bottom: 2rem;">
        <img src="logo.png" alt="JZL Soluciones" class="logo-img" onerror="this.style.display='none'">
      </div>
      
      <div style="text-align: center; margin-bottom: 2rem;">
        <div style="font-size: 4rem; margin-bottom: 1rem; color: #28a745;">‚úÖ</div>
        <h2 class="splash-title">¬°Solicitud Enviada!</h2>
        <p style="color: #666; margin-top: 0.5rem;">Hemos procesado tu solicitud de financiaci√≥n</p>
      </div>
      
      <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #28a745;">
        <h3 style="color: #00704a; margin-bottom: 1rem; text-align: center;">üìã Resumen de tu solicitud</h3>
        <div id="finalSummary" style="text-align: left; line-height: 1.6;"></div>
      </div>
      
      <button id="newRequestBtn" class="splash-button" style="background: linear-gradient(135deg, #28a745, #20c997);">
        üîÑ Nueva Solicitud
      </button>
    </div>
  </div>

  <script>
    // ========== VARIABLES GLOBALES ==========
    let map, marker, autocomplete, confirmMap, confirmMarker, confirmAutocomplete;
    let currentSystemValue = 0;
    let currentMonthlyBill = 0;
    let currentMonthlyPayment = 0;
    let currentDownPayment = 0;
    let financedAmount = 0;
    let financeTermMonths = 0;
    let totalPanels = 0;
    let totalKWp = 0;
    let sistemaConServicios = 0;
    
    // ========== CONSTANTES ACTUALIZADAS ==========
    const ANNUAL_INTEREST_RATE = 0.20; // 20% anual (reducido de 24%)
    const MONTHLY_INTEREST_RATE = Math.pow(1 + ANNUAL_INTEREST_RATE, 1/12) - 1; // 1.53% mensual
    const TARGET_PERCENTAGE = 0.7; // 70% de la factura
    
    // PAR√ÅMETROS DE LA FUNCI√ìN EXPONENCIAL PARA DESCUENTO POR ESCALA
    const A = 0.45;    // M√°ximo adicional posible (45%)
    const B = 0.15;    // Tasa de decrecimiento r√°pida
    const C = 0.12;    // M√≠nimo adicional asint√≥tico (12%)
    
    // ========== FUNCI√ìN EXPONENCIAL PARA DESCUENTO POR ESCALA ==========
    function calcularFactorAdicional(kWp) {
      const kWpLimitado = Math.min(kWp, 25);
      const adicional = A * Math.exp(-B * kWpLimitado) + C;
      return adicional;
    }
    
    function calcularFactorTotal(kWp) {
      return 1 + calcularFactorAdicional(kWp);
    }
    
    // ========== FUNCIONES DE FORMATEO ==========
    function formatoDineroCOP(valor) {
      if (valor >= 1000000) {
        return '$' + (valor/1000000).toFixed(1).replace('.', ',') + 'M';
      } else if (valor >= 1000) {
        return '$' + Math.round(valor/1000) + 'K';
      }
      return '$' + Math.round(valor).toLocaleString('es-CO');
    }
    
    function formatoDineroCompleto(valor) {
      return '$' + Math.round(valor).toLocaleString('es-CO');
    }
    
    // ========== FUNCIONES PARA VALIDACI√ìN DE COORDENADAS ==========
    function sonCoordenadasValidas(lat, lon) {
      const numLat = parseFloat(lat);
      const numLon = parseFloat(lon);
      return !isNaN(numLat) && !isNaN(numLon) && 
             numLat >= -90 && numLat <= 90 && 
             numLon >= -180 && numLon <= 180;
    }
    
    function obtenerCoordenadasDeInputs() {
      const lat = document.getElementById('latTxtSplash').value;
      const lon = document.getElementById('lonTxtSplash').value;
      
      if (sonCoordenadasValidas(lat, lon)) {
        return {
          lat: parseFloat(lat),
          lng: parseFloat(lon),
          source: 'coordenadas'
        };
      }
      return null;
    }
    
    // ========== C√ÅLCULO DEL SISTEMA SOLAR ==========
    async function calcularCotizacion(lat, lon, bill) {
      const PRICE_KWH = 890;
      const USD_COP = 4000;
      const USD_W_INSTALLED = 0.9;
      const PANEL_W = 450;
      const TARGET = 0.7;
      const AREA_POR_PANEL = 2.2;
      const COSTO_FIJO_COP = 3000000;
    
      try {
        const kwhMonth = bill / PRICE_KWH;
        const kwh70 = kwhMonth * TARGET;
    
        let specific = 1350;
    
        try {
          const response = await fetch(
            `https://developer.nrel.gov/api/pvwatts/v8.json?api_key=ECmQDDWbYsWgQ4pFg2zFUZdlbTirJhA1pnfQRRC4&lat=${lat}&lon=${lon}&system_capacity=1&azimuth=180&tilt=${Math.abs(lat)}&array_type=1&module_type=0&losses=14&timeframe=monthly`
          );
          
          if (response.ok) {
            const pvw = await response.json();
            if(pvw && pvw.outputs && pvw.outputs.ac_annual) {
              specific = pvw.outputs.ac_annual;
            }
          }
        } catch(error) {
          console.warn('Error PVWatts, usando valor por defecto:', error);
        }
    
        const kwp = (kwh70 * 12) / specific;
        totalPanels = Math.ceil(kwp / (PANEL_W/1000));
        totalKWp = totalPanels * (PANEL_W/1000);
        const kwpReal = totalPanels * (PANEL_W/1000);
    
        const priceUsd = kwpReal * 1000 * USD_W_INSTALLED;
        const valorBaseSistema = priceUsd * USD_COP + COSTO_FIJO_COP;
        
        // APLICAR DESCUENTO POR ESCALA
        const factorDescuento = calcularFactorTotal(totalKWp);
        currentSystemValue = valorBaseSistema * factorDescuento;
        sistemaConServicios = currentSystemValue;
        
        // Calcular pago mensual (70% de la factura)
        currentMonthlyPayment = bill * TARGET_PERCENTAGE;
        currentMonthlyBill = bill;
    
        return {
          systemValue: currentSystemValue,
          valorBaseSistema: valorBaseSistema,
          monthlyPayment: currentMonthlyPayment,
          panels: totalPanels,
          monthlyBill: currentMonthlyBill,
          kWp: totalKWp,
          factorDescuento: factorDescuento
        };
        
      } catch (error) {
        console.error('Error en c√°lculo:', error);
        throw error;
      }
    }
    
    // ========== C√ÅLCULO DE FINANCIACI√ìN ==========
    function calcularFinanciacion(valorTotal, pagoInicial, cuotaMensual) {
      const valorFinanciado = valorTotal - pagoInicial;
      const r = MONTHLY_INTEREST_RATE;
      const P = cuotaMensual;
      
      if (P <= 0) {
        return { meses: 0, totalIntereses: 0, totalPagado: 0, valorFinanciado: 0 };
      }
      
      if (valorFinanciado <= 0) {
        return { 
          meses: 0, 
          totalIntereses: 0, 
          totalPagado: pagoInicial,
          valorFinanciado: 0 
        };
      }
      
      if (P <= valorFinanciado * r) {
        return { 
          meses: Infinity, 
          totalIntereses: Infinity, 
          totalPagado: Infinity,
          valorFinanciado: valorFinanciado 
        };
      }
      
      const n = -Math.log(1 - (valorFinanciado * r) / P) / Math.log(1 + r);
      const meses = Math.ceil(n);
      const totalPagado = P * meses + pagoInicial;
      const totalIntereses = totalPagado - valorTotal;
      
      return {
        meses: meses,
        a√±os: Math.floor(meses / 12),
        mesesRestantes: meses % 12,
        totalIntereses: totalIntereses,
        totalPagado: totalPagado,
        valorFinanciado: valorFinanciado
      };
    }
    
    // ========== C√ÅLCULO DE LAS 3 M√âTRICAS DE ROI ==========
    function calcularMetricasROI(pagoInicial, ahorroMensual, sistemaConServicios, plazoMeses, saldoFinanciado) {
      const resultados = {
        // 1. Flujo mensual inmediato
        flujoMensual: 0,
        
        // 2. Tiempo para recuperar pago inicial (ROI simple)
        recuperacionPagoInicialAnios: 0,
        
        // 3. Tiempo para equilibrio del proyecto
        equilibrioProyectoAnios: 0
      };
      
      // 1. FLUJO MENSUAL INMEDIATO
      // Ahorro mensual - Inter√©s del primer mes
      if (saldoFinanciado > 0) {
        const interesPrimerMes = saldoFinanciado * MONTHLY_INTEREST_RATE;
        resultados.flujoMensual = ahorroMensual - interesPrimerMes;
      } else {
        resultados.flujoMensual = ahorroMensual; // Si no hay financiaci√≥n
      }
      
      // 2. RECUPERACI√ìN DEL PAGO INICIAL (ROI simple)
      // Tiempo para que el ahorro acumulado iguale el pago inicial
      if (resultados.flujoMensual > 0) {
        resultados.recuperacionPagoInicialAnios = (pagoInicial / (resultados.flujoMensual * 12));
      } else {
        resultados.recuperacionPagoInicialAnios = Infinity; // Nunca se recupera
      }
      
      // 3. EQUILIBRIO DEL PROYECTO (cuando se paga todo)
      // Simulaci√≥n mes a mes hasta encontrar el equilibrio
      if (resultados.flujoMensual > 0) {
        let saldo = saldoFinanciado;
        let ahorroAcumulado = 0;
        let interesesPagados = 0;
        
        for (let mes = 1; mes <= plazoMeses * 2; mes++) { // Buscar hasta el doble del plazo
          // Inter√©s del mes
          if (saldo > 0) {
            const interesMes = saldo * MONTHLY_INTEREST_RATE;
            interesesPagados += interesMes;
            
            // Capital pagado este mes
            const capitalMes = ahorroMensual - interesMes;
            saldo = Math.max(0, saldo - capitalMes);
          }
          
          // Ahorro acumulado
          ahorroAcumulado += ahorroMensual;
          
          // Inversi√≥n total hasta ahora
          const inversionTotal = pagoInicial + interesesPagados;
          
          // Verificar equilibrio
          if (ahorroAcumulado >= inversionTotal) {
            resultados.equilibrioProyectoAnios = mes / 12;
            break;
          }
          
          // Si ya no hay saldo pero a√∫n no hay equilibrio
          if (saldo <= 0 && ahorroAcumulado < (pagoInicial + interesesPagados)) {
            // Calcular tiempo restante basado en flujo mensual
            const deficit = (pagoInicial + interesesPagados) - ahorroAcumulado;
            const mesesRestantes = deficit / resultados.flujoMensual;
            resultados.equilibrioProyectoAnios = (mes + mesesRestantes) / 12;
            break;
          }
        }
      } else {
        resultados.equilibrioProyectoAnios = Infinity;
      }
      
      return resultados;
    }
    
    // ========== ACTUALIZAR INTERFAZ DE FINANCIACI√ìN ==========
    function actualizarFinanciacion() {
      const slider = document.getElementById('downPaymentSlider');
      const percentage = parseInt(slider.value);
      
      // Calcular pago inicial
      currentDownPayment = (sistemaConServicios * percentage) / 100;
      financedAmount = sistemaConServicios - currentDownPayment;
      
      // Actualizar valores en pantalla
      document.getElementById('downPaymentValue').textContent = formatoDineroCOP(currentDownPayment);
      document.getElementById('downPaymentPercentage').textContent = percentage + '%';
      document.getElementById('selectedDownPayment').textContent = formatoDineroCOP(currentDownPayment);
      document.getElementById('downPaymentPercent').textContent = percentage + '% del total';
      document.getElementById('monthlyPayment').textContent = formatoDineroCOP(currentMonthlyPayment);
      document.getElementById('financedAmount').textContent = formatoDineroCOP(financedAmount);
      
      // L√≠neas de financiamiento
      document.getElementById('systemWithServices').textContent = formatoDineroCOP(sistemaConServicios);
      document.getElementById('downPaymentLine').textContent = formatoDineroCOP(currentDownPayment);
      document.getElementById('balanceToFinance').textContent = formatoDineroCOP(financedAmount);
      
      // Calcular financiaci√≥n
      const resultadoFinanciacion = calcularFinanciacion(
        sistemaConServicios,
        currentDownPayment,
        currentMonthlyPayment
      );
      
      financeTermMonths = resultadoFinanciacion.meses;
      financedAmount = resultadoFinanciacion.valorFinanciado;
      
      // Formatear tiempo
      let tiempoTexto = '';
      if (resultadoFinanciacion.a√±os > 0) {
        tiempoTexto += resultadoFinanciacion.a√±os + ' a√±o' + (resultadoFinanciacion.a√±os !== 1 ? 's' : '');
      }
      if (resultadoFinanciacion.mesesRestantes > 0) {
        if (resultadoFinanciacion.a√±os > 0) tiempoTexto += ' ';
        tiempoTexto += resultadoFinanciacion.mesesRestantes + ' mes' + (resultadoFinanciacion.mesesRestantes !== 1 ? 'es' : '');
      }
      if (resultadoFinanciacion.a√±os === 0 && resultadoFinanciacion.mesesRestantes === 0) {
        if (currentDownPayment >= sistemaConServicios) {
          tiempoTexto = 'Pago completo';
        } else {
          tiempoTexto = 'Menos de 1 mes';
        }
      }
      
      if (resultadoFinanciacion.meses === Infinity) {
        tiempoTexto = 'No aplicable';
      }
      
      document.getElementById('financeTerm').textContent = tiempoTexto;
      document.getElementById('financeYears').textContent = resultadoFinanciacion.a√±os > 0 ? resultadoFinanciacion.a√±os + ' a√±os' : '';
      document.getElementById('estimatedTime').textContent = tiempoTexto;
      
      // Actualizar gr√°fica de timeline
      const maxMeses = 25 * 12;
      const progressPercentage = resultadoFinanciacion.meses === Infinity ? 100 : Math.min((financeTermMonths / maxMeses) * 100, 100);
      document.getElementById('timelineProgress').style.width = progressPercentage + '%';
      
      // Actualizar marcadores de timeline
      if (resultadoFinanciacion.a√±os > 0) {
        const mitadA√±os = Math.floor(resultadoFinanciacion.a√±os / 2);
        document.getElementById('midTerm').textContent = mitadA√±os + ' a√±os';
        document.getElementById('endTerm').textContent = resultadoFinanciacion.a√±os + ' a√±os';
      } else {
        document.getElementById('midTerm').textContent = 'Mitad';
        document.getElementById('endTerm').textContent = 'Final';
      }
      
      // Calcular m√©tricas ROI
      const roiMetrics = calcularMetricasROI(
        currentDownPayment,
        currentMonthlyPayment,
        sistemaConServicios,
        financeTermMonths,
        financedAmount
      );
      
      // Actualizar m√©tricas ROI en la interfaz
      // 1. Flujo mensual inmediato
      if (roiMetrics.flujoMensual > 0) {
        document.getElementById('roiFlujoMensual').textContent = '+ ' + formatoDineroCOP(roiMetrics.flujoMensual) + '/mes';
        document.getElementById('roiFlujoMensual').style.color = '#28a745';
      } else {
        document.getElementById('roiFlujoMensual').textContent = formatoDineroCOP(roiMetrics.flujoMensual) + '/mes';
        document.getElementById('roiFlujoMensual').style.color = '#e74c3c';
      }
      
      // 2. Recuperaci√≥n pago inicial
      if (roiMetrics.recuperacionPagoInicialAnios !== Infinity) {
        if (roiMetrics.recuperacionPagoInicialAnios < 1) {
          const meses = Math.round(roiMetrics.recuperacionPagoInicialAnios * 12);
          document.getElementById('roiRecuperacion').textContent = meses + ' meses';
          document.getElementById('roiRecuperacionDetail').textContent = 'Recuperas r√°pido tu inversi√≥n';
        } else {
          document.getElementById('roiRecuperacion').textContent = roiMetrics.recuperacionPagoInicialAnios.toFixed(1) + ' a√±os';
          document.getElementById('roiRecuperacionDetail').textContent = 'Tiempo para recuperar tu inversi√≥n';
        }
      } else {
        document.getElementById('roiRecuperacion').textContent = 'No aplica';
        document.getElementById('roiRecuperacionDetail').textContent = 'El flujo no es positivo';
      }
      
      // 3. Equilibrio del proyecto
      if (roiMetrics.equilibrioProyectoAnios !== Infinity) {
        if (roiMetrics.equilibrioProyectoAnios < 1) {
          const meses = Math.round(roiMetrics.equilibrioProyectoAnios * 12);
          document.getElementById('roiEquilibrio').textContent = meses + ' meses';
          document.getElementById('roiEquilibrioDetail').textContent = 'El proyecto se paga r√°pido';
        } else {
          document.getElementById('roiEquilibrio').textContent = roiMetrics.equilibrioProyectoAnios.toFixed(1) + ' a√±os';
          document.getElementById('roiEquilibrioDetail').textContent = 'Cuando el proyecto se paga solo';
        }
      } else {
        document.getElementById('roiEquilibrio').textContent = 'No aplica';
        document.getElementById('roiEquilibrioDetail').textContent = 'No se alcanza el equilibrio';
      }
      
      // Actualizar ahorro inmediato
      const nuevaFactura = currentMonthlyBill - currentMonthlyPayment;
      const ahorroInmediato = currentMonthlyBill - nuevaFactura;
      document.getElementById('immediateSavings').textContent = formatoDineroCOP(ahorroInmediato) + '/mes';
      document.getElementById('originalBill').textContent = 'Factura actual: ' + formatoDineroCOP(currentMonthlyBill);
      document.getElementById('newBill').textContent = 'Nueva factura: ' + formatoDineroCOP(nuevaFactura);
    }
    
    // ========== INICIALIZAR PANTALLA DE FINANCIACI√ìN ==========
    function inicializarPantallaFinanciacion(sistemaData) {
      document.getElementById('totalPanels').textContent = sistemaData.panels;
      document.getElementById('totalKWp').textContent = sistemaData.kWp.toFixed(1);
      document.getElementById('totalSystemValue').textContent = formatoDineroCOP(sistemaData.valorBaseSistema);
      document.getElementById('maxDownPaymentLabel').textContent = formatoDineroCOP(sistemaConServicios);
      
      // Mostrar descuento por escala
      const descuentoAdicional = (sistemaData.factorDescuento - 1) * 100;
      if (descuentoAdicional > 0) {
        document.getElementById('scaleDiscountDisplay').style.display = 'block';
        document.getElementById('discountPercentage').textContent = descuentoAdicional.toFixed(1) + '%';
      }
      
      // Configurar slider
      const slider = document.getElementById('downPaymentSlider');
      slider.max = 100;
      slider.value = 20;
      
      // Event listener para slider
      slider.addEventListener('input', function() {
        document.getElementById('downPaymentPercentage').textContent = this.value + '%';
        actualizarFinanciacion();
      });
      
      // Calcular primera vez
      actualizarFinanciacion();
    }
    
    // ========== FUNCIONES DE MAPAS CORREGIDAS ==========
    function initMap() {
      console.log('‚úÖ Google Maps API cargada');
      
      // INICIALIZAR AUTOCOMPLETE PARA LA PRIMERA PANTALLA
      const splashInput = document.getElementById('searchBoxSplash');
      
      // Crear autocomplete con configuraci√≥n correcta
      const autocomplete = new google.maps.places.Autocomplete(splashInput, {
        fields: ['geometry', 'formatted_address'],
        types: ['address'],
        componentRestrictions: { country: 'co' }
      });
      
      // Manejar selecci√≥n de lugar
      autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        
        if (!place.geometry) {
          console.log('‚ùå No se encontr√≥ la ubicaci√≥n');
          return;
        }
        
        const lat = place.geometry.location.lat();
        const lng = place.geometry.location.lng();
        
        // Actualizar campos de coordenadas
        document.getElementById('latTxtSplash').value = lat.toFixed(6);
        document.getElementById('lonTxtSplash').value = lng.toFixed(6);
        
        console.log('‚úÖ Direcci√≥n seleccionada:', place.formatted_address);
        console.log('‚úÖ Coordenadas actualizadas:', lat, lng);
        
        // Actualizar el campo de b√∫squeda con la direcci√≥n formateada
        if (place.formatted_address) {
          splashInput.value = place.formatted_address;
        }
      });
      
      // Prevenir el env√≠o del formulario al presionar Enter en el autocomplete
      splashInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
        }
      });
      
      // Valores por defecto para Bogot√°
      document.getElementById('latTxtSplash').value = "4.7110";
      document.getElementById('lonTxtSplash').value = "-74.0721";
      
      console.log('‚úÖ Autocomplete configurado correctamente para la primera pantalla');
    }
    
    function initConfirmMap(lat, lng, address) {
      console.log('üìç Inicializando mapa de confirmaci√≥n con:', lat, lng);
      
      const location = { lat: lat, lng: lng };
      
      confirmMap = new google.maps.Map(document.getElementById('confirmMap'), {
        zoom: 16,
        center: location,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        styles: [
          {
            featureType: "poi",
            elementType: "labels",
            stylers: [{ visibility: "off" }]
          }
        ]
      });
    
      // Configurar autocomplete para direcci√≥n en confirmaci√≥n
      const confirmAddressInput = document.getElementById('confirmAddress');
      const confirmAutocomplete = new google.maps.places.Autocomplete(confirmAddressInput, {
        fields: ['geometry', 'formatted_address'],
        types: ['address'],
        componentRestrictions: { country: 'co' }
      });
      
      confirmAutocomplete.bindTo('bounds', confirmMap);
      
      confirmAutocomplete.addListener('place_changed', function() {
        const place = confirmAutocomplete.getPlace();
        if (!place.geometry) return;
        
        const newLocation = place.geometry.location;
        confirmMap.setCenter(newLocation);
        confirmMarker.setPosition(newLocation);
        updateConfirmCoords(newLocation.lat(), newLocation.lng());
        
        if (place.formatted_address) {
          confirmAddressInput.value = place.formatted_address;
        }
      });
    
      confirmMarker = new google.maps.Marker({
        position: location,
        map: confirmMap,
        draggable: true,
        title: 'Arrastra para ajustar la ubicaci√≥n',
        animation: google.maps.Animation.DROP
      });
    
      confirmMarker.addListener('dragend', function() {
        const newPosition = confirmMarker.getPosition();
        updateConfirmCoords(newPosition.lat(), newPosition.lng());
        reverseGeocode(newPosition.lat(), newPosition.lng());
      });
    
      document.getElementById('confirmAddress').value = address || '';
      updateConfirmCoords(lat, lng);
      
      setTimeout(() => {
        confirmMap.setCenter(location);
        confirmMap.setZoom(16);
      }, 100);
      
      document.getElementById('confirmLat').addEventListener('change', function() {
        const lat = parseFloat(this.value);
        const lon = parseFloat(document.getElementById('confirmLon').value);
        if (sonCoordenadasValidas(lat, lon)) {
          const newLocation = new google.maps.LatLng(lat, lon);
          confirmMap.setCenter(newLocation);
          confirmMarker.setPosition(newLocation);
          reverseGeocode(lat, lon);
        }
      });
    
      document.getElementById('confirmLon').addEventListener('change', function() {
        const lat = parseFloat(document.getElementById('confirmLat').value);
        const lon = parseFloat(this.value);
        if (sonCoordenadasValidas(lat, lon)) {
          const newLocation = new google.maps.LatLng(lat, lon);
          confirmMap.setCenter(newLocation);
          confirmMarker.setPosition(newLocation);
          reverseGeocode(lat, lon);
        }
      });
    }
    
    function updateConfirmCoords(lat, lng) {
      document.getElementById('confirmLat').value = lat.toFixed(5);
      document.getElementById('confirmLon').value = lng.toFixed(5);
    }
    
    function reverseGeocode(lat, lng) {
      const geocoder = new google.maps.Geocoder();
      const latLng = { lat: lat, lng: lng };
      
      geocoder.geocode({ location: latLng }, (results, status) => {
        if (status === "OK" && results[0]) {
          document.getElementById('confirmAddress').value = results[0].formatted_address;
        }
      });
    }
    
    // ========== FLUJO PRINCIPAL ==========
    async function cotizarDesdeSplash() {
      console.log('üöÄ Iniciando c√°lculo desde splash...');
      
      let coordenadas = obtenerCoordenadasDeInputs();
      let address = document.getElementById('searchBoxSplash').value;
      
      console.log('üìå Direcci√≥n ingresada:', address);
      console.log('üìå Coordenadas obtenidas:', coordenadas);
      
      if (!coordenadas && !address.trim()) {
        alert('Por favor ingresa una direcci√≥n o coordenadas v√°lidas');
        return;
      }
    
      let lat, lon;
      
      if (coordenadas) {
        lat = coordenadas.lat;
        lon = coordenadas.lng;
        console.log('‚úÖ Usando coordenadas ingresadas:', lat, lon);
      } else {
        alert('Por favor ingresa coordenadas v√°lidas o selecciona una direcci√≥n de las sugerencias');
        return;
      }
    
      const bill = parseFloat(document.getElementById('billSplash').value);
      
      if(isNaN(bill) || bill <= 0){ 
        alert('Define una factura mayor a 0'); 
        return; 
      }
    
      document.getElementById('splashScreen').style.display = 'none';
      document.getElementById('confirmLocationScreen').style.display = 'flex';
      
      initConfirmMap(lat, lon, address);
    }
    
    async function confirmarUbicacion() {
      const lat = parseFloat(document.getElementById('confirmLat').value);
      const lon = parseFloat(document.getElementById('confirmLon').value);
      const bill = parseFloat(document.getElementById('billSplash').value);
      
      document.getElementById('latTxtSplash').value = lat.toFixed(5);
      document.getElementById('lonTxtSplash').value = lon.toFixed(5);
      document.getElementById('searchBoxSplash').value = document.getElementById('confirmAddress').value;
    
      try {
        const sistemaData = await calcularCotizacion(lat, lon, bill);
        console.log('üìä Sistema calculado:', sistemaData);
        
        document.getElementById('confirmLocationScreen').style.display = 'none';
        document.getElementById('financeScreen').style.display = 'flex';
        
        inicializarPantallaFinanciacion(sistemaData);
        
      } catch (error) {
        alert('Error en el c√°lculo. Verifica los datos.');
        console.error('‚ùå Error:', error);
      }
    }
    
    // ========== FUNCI√ìN PARA MOSTRAR RESUMEN FINAL ==========
    function mostrarResumenFinal() {
      const nuevaFactura = currentMonthlyBill - currentMonthlyPayment;
      const ahorroInmediato = currentMonthlyBill - nuevaFactura;
      const sliderValue = document.getElementById('downPaymentSlider').value;
      const a√±osFinanciacion = Math.floor(financeTermMonths / 12);
      const mesesFinanciacion = financeTermMonths % 12;
      
      let tiempoTexto = '';
      if (a√±osFinanciacion > 0) {
        tiempoTexto += a√±osFinanciacion + ' a√±o' + (a√±osFinanciacion !== 1 ? 's' : '');
      }
      if (mesesFinanciacion > 0) {
        if (a√±osFinanciacion > 0) tiempoTexto += ' ';
        tiempoTexto += mesesFinanciacion + ' mes' + (mesesFinanciacion !== 1 ? 'es' : '');
      }
      
      // Calcular m√©tricas ROI para el resumen
      const roiMetrics = calcularMetricasROI(
        currentDownPayment,
        currentMonthlyPayment,
        sistemaConServicios,
        financeTermMonths,
        financedAmount
      );
      
      let flujoTexto = 'No aplica';
      if (roiMetrics.flujoMensual > 0) {
        flujoTexto = '+ ' + formatoDineroCOP(roiMetrics.flujoMensual) + '/mes';
      }
      
      let recuperacionTexto = 'No aplica';
      if (roiMetrics.recuperacionPagoInicialAnios !== Infinity) {
        if (roiMetrics.recuperacionPagoInicialAnios < 1) {
          recuperacionTexto = Math.round(roiMetrics.recuperacionPagoInicialAnios * 12) + ' meses';
        } else {
          recuperacionTexto = roiMetrics.recuperacionPagoInicialAnios.toFixed(1) + ' a√±os';
        }
      }
      
      const resumenHTML = `
        <div style="display: grid; grid-template-columns: 1fr; gap: 0.75rem;">
          <div style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid #d4edda;">
            <span>üí∞ Pago inicial:</span>
            <strong>${sliderValue}% (${formatoDineroCompleto(currentDownPayment)})</strong>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid #d4edda;">
            <span>üìÖ Cuota mensual:</span>
            <strong>${formatoDineroCompleto(currentMonthlyPayment)}</strong>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid #d4edda;">
            <span>‚è±Ô∏è Tiempo financiaci√≥n:</span>
            <strong>${tiempoTexto}</strong>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid #d4edda;">
            <span>üí∏ Flujo mensual:</span>
            <strong style="color: ${roiMetrics.flujoMensual > 0 ? '#28a745' : '#e74c3c'};">${flujoTexto}</strong>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid #d4edda;">
            <span>üéØ Recuperaci√≥n inversi√≥n:</span>
            <strong>${recuperacionTexto}</strong>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #d4edda; border-radius: 6px; margin-top: 0.5rem;">
            <span>üìä Valor financiado:</span>
            <strong>${formatoDineroCompleto(financedAmount)}</strong>
          </div>
        </div>
      `;
      
      document.getElementById('finalSummary').innerHTML = resumenHTML;
    }
    
    // ========== FUNCI√ìN PARA ENVIAR SOLICITUD ==========
    async function enviarSolicitudFinanciacion() {
      const userName = document.getElementById('userName').value;
      const userEmail = document.getElementById('userEmail').value;
      const userPhone = document.getElementById('userPhone').value;
    
      if (!userName || !userEmail || !userPhone) {
        alert('Por favor completa todos los campos');
        return;
      }
    
      const botonOriginal = document.getElementById('sendFinanceBtn');
      const textoOriginal = botonOriginal.textContent;
      
      botonOriginal.textContent = 'Enviando...';
      botonOriginal.disabled = true;
    
      try {
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        mostrarResumenFinal();
        document.getElementById('formScreen').style.display = 'none';
        document.getElementById('finalScreen').style.display = 'flex';
        
      } catch (error) {
        alert('Error al enviar la solicitud. Por favor intenta nuevamente.');
        botonOriginal.textContent = textoOriginal;
        botonOriginal.disabled = false;
      }
    }
    
    // ========== FUNCI√ìN PARA VOLVER AL MEN√ö ANTERIOR ==========
    function volverAlMenuAnterior(pantallaActual, pantallaAnterior) {
      document.getElementById(pantallaActual).style.display = 'none';
      document.getElementById(pantallaAnterior).style.display = 'flex';
    }
    
    // ========== EVENT LISTENERS ==========
    document.addEventListener('DOMContentLoaded', function() {
      console.log('‚úÖ DOM cargado');
      
      // Botones principales
      document.getElementById('cotizarSplash').addEventListener('click', cotizarDesdeSplash);
      document.getElementById('confirmLocationBtn').addEventListener('click', confirmarUbicacion);
      document.getElementById('nextToFormBtn').addEventListener('click', function() {
        volverAlMenuAnterior('financeScreen', 'formScreen');
      });
      document.getElementById('sendFinanceBtn').addEventListener('click', enviarSolicitudFinanciacion);
      
      // Botones volver
      document.getElementById('backToSplashFromConfirm').addEventListener('click', function() {
        volverAlMenuAnterior('confirmLocationScreen', 'splashScreen');
      });
      document.getElementById('backToConfirmFromFinance').addEventListener('click', function() {
        volverAlMenuAnterior('financeScreen', 'confirmLocationScreen');
      });
      document.getElementById('backToFinanceFromForm').addEventListener('click', function() {
        volverAlMenuAnterior('formScreen', 'financeScreen');
      });
      
      // Bot√≥n nueva solicitud
      document.getElementById('newRequestBtn').addEventListener('click', function() {
        window.location.reload();
      });
      
      // Enter para enviar en el splash
      document.getElementById('billSplash').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('cotizarSplash').click();
        }
      });
    });
  </script>

  <!-- Carga de Google Maps -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAKNxSVeV-p40IVdXtU7Ghk7p-WdMnrZes&libraries=places&callback=initMap">
  </script>
</body>
</html>



